<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lhjl.tzzs.proxy.mapper.ProjectsMapper" >
  <resultMap id="BaseResultMap" type="com.lhjl.tzzs.proxy.model.Projects" >
    <!--
      WARNING - @mbg.generated
    -->
    <id column="ID" property="id" jdbcType="INTEGER" />
    <result column="serial_number" property="serialNumber" jdbcType="INTEGER" />
    <result column="short_name" property="shortName" jdbcType="VARCHAR" />
    <result column="full_name" property="fullName" jdbcType="VARCHAR" />
    <result column="kernel_desc" property="kernelDesc" jdbcType="VARCHAR" />
    <result column="commet" property="commet" jdbcType="VARCHAR" />
    <result column="url" property="url" jdbcType="VARCHAR" />
    <result column="established_time" property="establishedTime" jdbcType="DATE" />
    <result column="segmentation" property="segmentation" jdbcType="VARCHAR" />
    <result column="item_label" property="itemLabel" jdbcType="VARCHAR" />
    <result column="address" property="address" jdbcType="VARCHAR" />
    <result column="territory" property="territory" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="continent" property="continent" jdbcType="VARCHAR" />
    <result column="country" property="country" jdbcType="VARCHAR" />
    <result column="province" property="province" jdbcType="VARCHAR" />
    <result column="city" property="city" jdbcType="VARCHAR" />
    <result column="region" property="region" jdbcType="VARCHAR" />
    <result column="investment_institutions_id" property="investmentInstitutionsId" jdbcType="INTEGER" />
  </resultMap>
   
    <!-- 用户关注的项目 -->
  <select id="findProjectByUserId" parameterType="String" resultMap="BaseResultMap" >
  	SELECT ID,short_name,kernel_desc FROM projects WHERE id IN (SELECT projects_id FROM follow WHERE STATUS=1 AND user_id=#{userId})
  </select>
   <!-- <select id="findProjectByShortName" parameterType="String" resultMap="BaseResultMap" >
    SELECT p.*,s.* FROM projects p LEFT JOIN (SELECT ff.* FROM follow ff WHERE ff.ID IN(SELECT MAX(f.ID) FROM follow f GROUP BY  f.projects_id)) s ON p.ID=s.projects_id WHERE p.`short_name` LIKE '%"#{shortName}"%';
  </select> -->
   <!-- 查询所有的-->
  <select id="findProjectByShortNameAll" resultType="java.util.HashMap">
   <!-- SELECT b.*,
   (SELECT COUNT(*) FROM follow a WHERE a.projects_id = b.`ID` AND a.status = 1)num,
   (SELECT MAX(f.status)s FROM follow f WHERE f.user_id = #{userId,jdbcType=VARCHAR}) AND f.projects_id = b.`ID` GROUP BY f.projects_id ) zz
   FROM projects b
   WHERE short_name LIKE CONCAT('%',#{shortName,jdbcType=VARCHAR},'%')  -->
   SELECT b.*,
	(SELECT COUNT(*) FROM follow a WHERE a.projects_id = b.`ID` AND a.status = 1)num,
	(SELECT MAX(f.status)s FROM follow f WHERE f.user_id = #{userId, jdbcType=VARCHAR} AND f.projects_id = b.`ID` GROUP BY f.projects_id )yn
	FROM projects b
	WHERE short_name LIKE CONCAT('%',#{shortName,jdbcType=VARCHAR},'%')
	
     </select>
	<select id="findProjectByShortName"  parameterType="String" resultType="java.util.HashMap">
    SELECT b.*,
	(SELECT COUNT(*) FROM follow a WHERE a.projects_id = b.`ID` AND a.status = 1)num,
	(SELECT MAX(f.status)s FROM follow f WHERE f.user_id = #{userId, jdbcType=VARCHAR} AND f.projects_id = b.`ID` GROUP BY f.projects_id )yn
	FROM projects b
	WHERE short_name LIKE CONCAT('%',#{shortName,jdbcType=VARCHAR},'%') LIMIT 3
	</select>
	
	<select id="findProjectBySview" parameterType="com.lhjl.tzzs.proxy.dto.SereachDto" resultType="java.util.HashMap">
	
     SELECT mf.*,
     (SELECT COUNT(*) FROM follow a WHERE a.projects_id = mf.`ID` AND a.status = 1)num,
     (SELECT MAX(f.status)s FROM follow f WHERE f.user_id = #{userId} AND f.projects_id = mf.`ID` GROUP BY f.projects_id )yn
     FROM view_projects_info mf where 1=1
	 <if test=" types !='' and types.length > 0">
       AND mf.investment_institutions_type IN
       <foreach item="item" index="index" collection="types" open="(" separator="," close=")">#{item}</foreach>
     </if>
       <if test=" segmentations !='' and segmentations.length > 0">
       AND mf.segmentation IN
       <foreach item="item" index="index" collection="segmentations" open="(" separator="," close=")">#{item}</foreach>
      </if>
        
     <if test=" stages !='' and stages.length > 0">
       AND mf.stage IN
       <foreach item="item" index="index" collection="stages" open="(" separator="," close=")">#{item}</foreach>
     </if>
       
       <if test=" cities !='' and cities.length > 0">
       AND mf.city IN
       <foreach item="item" index="index" collection="cities" open="(" separator="," close=")">#{item}</foreach>
      </if>
 
       <if test=" working_background_descs!='' and working_background_descs.length > 0">
       AND mf.work_experience IN
       <foreach item="item" index="index" collection="working_background_descs" open="(" separator="," close=")">#{item}</foreach>
       </if>
      
       <if test="educational_background_descs!='' and educational_background_descs.length > 0">
       AND mf.education_experience IN
       <foreach item="item" index="index" collection="educational_background_descs" open="(" separator="," close=")">#{item}</foreach>
       </if>
	 </select>

    <select id="findByTodayProjects" resultMap="BaseResultMap" parameterType="com.lhjl.tzzs.proxy.model.Projects">
        select * from projects where investment_institutions_id =#{investmentInstitutionsId} and short_name =#{shortName} and to_days(create_time) = to_days(now())
    </select>

    <select id="maxSerialNumber" resultMap="BaseResultMap">
        select * from projects where serial_number between 100000 and 200000 order by serial_number desc;
    </select>
</mapper>